<!DOCTYPE html>
<html lang="en">

    <head>
        <title>Create Purchase Order Page</title>

        <!-- Meta -->
        <th:block th:replace="/layout/head/meta :: meta"/>
        <!-- App-favicon -->
        <th:block th:replace="/layout/head/app-favicon :: app-favicon"/>
        <link rel="stylesheet" href="/assets/css/bootstrap/jquery.bootstrap-touchspin.min.css">
        <!-- Main -->
        <th:block th:replace="/layout/head/main :: main"/>

    </head>

    <body data-sidebar="dark">

        <!-- Begin page -->
        <div id="layout-wrapper">
            <!-- Begin page-topbar -->
            <th:block th:replace="/layout/page-topbar :: page-topbar"/>
            <!-- End page-topbar -->

            <!-- Begin vertical-menu -->
            <th:block th:replace="/layout/vertical-menu :: vertical-menu"/>
            <!-- End vertical-menu -->

            <!-- Left Sidebar End -->

            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">

                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box d-flex align-items-center justify-content-between">
                                    <h4 class="mb-0 font-size-18">Create Purchase Order</h4>
                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="javascript: void(0);">Purchase Order</a></li>
                                            <li class="breadcrumb-item active">Create</li>
                                        </ol>
                                    </div>

                                </div>
                                <div class="position-relative col-sm-8 mb-3">
                                    <input type="text" class="form-control" placeholder="Search product...">
                                </div>
                            </div>
                        </div>
                        <!-- end page title -->

                        <div class="row">
                            <div class="col-xl-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-centered mb-0 table-nowrap">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Product</th>
                                                        <th>Product Desc</th>
                                                        <th>Price</th>
                                                        <th>Available</th>
                                                        <th>Quantity</th>
                                                        <th colspan="2">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <img src="assets\images\product\img-1.png" alt="product-img" title="product-img" class="avatar-md">
                                                        </td>
                                                        <td>
                                                            <h5 class="font-size-14 text-truncate"><a href="/products/details/${slug}" class="text-dark">Half sleeve T-shirt</a></h5>
                                                        </td>
                                                        <td>
                                                            $ 450
                                                        </td>
                                                        <td>
                                                            10
                                                        </td>
                                                        <td>
                                                            <div style="width: 120px;">
                                                                <div class="input-group  bootstrap-touchspin bootstrap-touchspin-injected">
                                                                    <input type="text" value="02" name="demo_vertical" class="form-control">
                                                                    <span class="input-group-btn-vertical">
                                                                        <button class="btn btn-primary bootstrap-touchspin-up " type="button">+</button>
                                                                        <button class="btn btn-primary bootstrap-touchspin-down " type="button">-</button>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            $ 900
                                                        </td>
                                                        <td>
                                                            <a href="javascript:void(0);" class="action-icon text-danger"> <i class="mdi mdi-trash-can font-size-18"></i></a>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-sm-6">
                                                <a href="/purchase-orders/list" class="btn btn-secondary">
                                                    <i class="mdi mdi-arrow-left mr-1"></i>
                                                    Purchase Order List
                                                </a>
                                            </div> <!-- end col -->
                                            <div class="col-sm-6">
                                                <div class="text-sm-right mt-2 mt-sm-0">
                                                    <button id="btnCreatePurchaseOrder" type="button" class="btn btn-success">
                                                        <i class="mdi mdi-cart-arrow-right mr-1"></i>
                                                        Checkout
                                                    </button>
                                                </div>
                                            </div> <!-- end col -->
                                        </div> <!-- end row-->
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-sm-4">
                                                <h4 class="card-title mb-3">Suppplier</h4>
                                            </div>
                                            <div class="col-sm-8 text-sm-right">
                                                <button id="btnShowCreateSupplierModal" type="button" class="btn btn-primary btn-rounded waves-effect waves-light mb-2 mr-2">
                                                    <i class="mdi mdi-plus mr-1"></i>
                                                    Add New Supplier
                                                </button>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <select class="form-control" id="">
                                                <option>Select</option>
                                                <option>Shopee</option>
                                                <option>Tiki</option>
                                            </select>
                                        </div>

                                        <div class="table-responsive">
                                            <table class="table mb-0">
                                                <tbody>
                                                <tr>
                                                    <td>Address :</td>
                                                    <td>28 NTP</td>
                                                </tr>
                                                <tr>
                                                    <td>Ward : </td>
                                                    <td>Phường Phú Nhuận</td>
                                                </tr>
                                                <tr>
                                                    <td>District :</td>
                                                    <td>Thành phố Huế</td>
                                                </tr>
                                                <tr>
                                                    <td>Province : </td>
                                                    <td>Thừa Thiên Huế</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- end table-responsive -->
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title mb-3">Order Summary</h4>

                                        <div class="table-responsive">
                                            <table class="table mb-0">
                                                <tbody>
                                                    <tr>
                                                        <td>Total Quantity : </td>
                                                        <td>10</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Total Amount :</td>
                                                        <td>$ 1,857</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- end table-responsive -->
                                    </div>
                                </div>
                                <!-- end card -->
                            </div>
                        </div>
                        <!-- end row -->
                    </div>
                    <!-- container-fluid -->
                </div>
            </div>
            <!-- End Page-content -->
        </div>
        <!-- END layout-wrapper -->

        <th:block th:replace="/purchase-order/modal_create_supplier"/>

        <!-- Right Sidebar -->
        <th:block th:replace="/layout/right-bar :: right-bar"/>
        <!-- End right-bar -->

        <!-- JAVASCRIPT -->
        <th:block th:replace="/layout/script/javascript :: javascript"/>
        <!-- App js -->
        <th:block th:replace="/layout/script/app-js :: app-js"/>
    </body>

    <script>
        let userDTOId = $('.userDTO span').attr('id');

        let page = {
            url: {
                getAllProvinces: App.GET_PROVINCES + "/",
                getAllDistricts: App.GET_PROVINCES + "/district/",
                getAllWards: App.GET_PROVINCES + "/ward/",
            },
            elements: {
                role: {},
                userInfo: {
                    locationRegion: {}
                },

            },
            loadData: {},
            commands: {},
            dialogs: {
                elements: {},
                commands: {},
                alertDanger: {}
            },

            initializeControlEvent: {}
        }

        let locationRegion = {};

        page.elements.btnShowCreateSupplierModal = $('#btnShowCreateSupplierModal');
        page.elements.mdCreateSupplier = $('#mdCreateSupplier');
        page.elements.btnCreateSupplier = $('#btnCreateSupplier')

        page.elements.codeUnit = $('#codeUnit');
        page.elements.addressUnit = $('#addressUnit');

        page.elements.wardUnit = $('#wardUnit');
        page.elements.districtUnit = $('#districtUnit');
        page.elements.provinceUnit = $('#provinceUnit');

        page.elements.nameUnitCre = $('#companyNameCre');
        page.elements.phoneCre = $('#phoneCre');
        page.elements.emailCre = $('#emailCre');
        page.elements.addressCre = $('#addressCre');
        page.elements.wardCre = $('#wardCre');
        page.elements.districtCre = $('#districtCre');
        page.elements.provinceCre = $('#provinceCre');

        page.dialogs.alertDanger.mdCreateSupplier = $("#mdCreateSupplier .modal-alert-danger");

        page.commands.addRowCartItem = () =>{
            let str = App.getTempRowCartItemInCartImportOrder(cartItem);
            $('#tbListCartItems tbody').prepend(str);
        }

        page.commands.clickRowCartItem = () => {
            $("#tbListCartItems tbody tr").on("click", function () {
                cartItemId = $(this).attr('id').replace('tr_', '');

                $('#tbListCartItems tbody tr td span.select-tab').removeClass("selected").addClass("unselected");
                $(`#tbListCartItems tbody tr#tr_${cartItemId} td span.select-tab`).removeClass("unselected").addClass("selected");
            });

            page.commands.unbindAll();
        }

        page.loadData.loadCartItems = () => {
            return $.ajax({
                "headers": {
                    "accept" : "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.getAllCartItems,
                "data": userDTOId
            })
                .done((data) => {
                    cart = data.cartDTO;

                    $('#tbListCartItems tbody').html('');
                    $.each(data.cartItemDTO, (i, item) => {
                        cartItem = item;
                        page.commands.addRowCartItem();
                    })

                    page.elements.quantityTotal.text(cart.quantityTotal);
                    page.elements.grandTotal.text('$'+cart.grandTotal);

                    page.commands.clickRowCartItem();
                })
        };

        page.commands.drawUnits = () => {
            return $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": page.url.getAllUnits
            })
                .done((data) => {
                    $.each(data, (i, item) => {
                        let str = `<option value="${item.id}">${item.name} (${item.code})</option>`;

                        page.elements.unit.append(str);
                    })
                })
                .fail((jqxHR) => {
                    console.log(jqxHR);
                })
        }

        page.commands.drawProvinces = () => {
            return $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": page.url.getAllProvinces
            })
                .done((data) => {
                    $.each(data.results, (i, item) => {
                        let str = `<option value="${item.province_id}">${item.province_name}</option>`;

                        page.elements.provinceUnitCre.append(str);
                    })
                })
                .fail((jqxHR) => {
                    console.log(jqxHR);
                })
        }

        page.commands.drawDistricts = (provinceId) => {
            return $.ajax({
                "headers": {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": page.url.getAllDistricts + provinceId
            })
                .done((data) => {

                    if (data.results.length === 0) {
                        App.IziToast.showErrorAlert("Loading of districts is fail");
                    }else {
                        $.each(data.results, (i, item) => {
                            let str = `<option value="${item.district_id}">${item.district_name}</option>`;

                            page.elements.districtUnitCre.append(str)
                        })
                    }
                })
        }

        page.commands.drawWards = (districtId) => {
            return $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": page.url.getAllWards + districtId

            })
                .done((data) => {
                    if (data.results.length === 0) {
                        App.IziToast.showErrorAlert("Loading of wards is fail");
                    }else {
                        $.each(data.results, (i, item) => {
                            let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;

                            page.elements.wardUnitCre.append(str)
                        })
                    }
                })
        }

        page.dialogs.commands.provinceChange = () => {
            return $.ajax({
                "type": "GET",
                "url": page.url.getAllDistricts + locationRegion.provinceId
            }).done((data) => {
                page.elements.districtUnitCre.empty();

                $.each(data.results, (i, item) => {
                    let str = `<option value="${item.district_id}">${item.district_name}</option>`;

                    page.elements.districtUnitCre.append(str);
                });
            }).fail(function () {
                App.IziToast.showErrorAlert("Loading of districts is fail");
            });
        }

        page.dialogs.commands.districtChange = () => {
            $.ajax({
                "type": "GET",
                "url": page.url.getAllWards + locationRegion.districtId

            }).done((data) => {
                page.elements.wardUnitCre.empty();

                $.each(data.results, (i, item) => {
                    let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;

                    page.elements.wardUnitCre.append(str);
                });
            }).fail(function () {
                App.IziToast.showErrorAlert("Loading of wards is fail");
            });
        }

        page.commands.unitChange = () => {
            $.ajax({
                "type": "GET",
                "url": page.url.getUnitById + unitId

            }).done((data) => {
                unit = data;

                page.elements.codeUnit.text(data.code);
                page.elements.addressUnit.text(data.locationRegion.address);
                page.elements.wardUnit.text(data.locationRegion.wardName);
                page.elements.districtUnit.text(data.locationRegion.districtName);
                page.elements.provinceUnit.text(data.locationRegion.provinceName);
            })
        }

        page.commands.doCreateSupplier = () => {

            locationRegion.id = "0";
            locationRegion.provinceId = page.elements.provinceUnitCre.val();
            locationRegion.provinceName = page.elements.provinceUnitCre.find(":selected").text();
            locationRegion.districtId = page.elements.districtUnitCre.val();
            locationRegion.districtName = page.elements.districtUnitCre.find(":selected").text();
            locationRegion.wardId = page.elements.wardUnitCre.val();
            locationRegion.wardName = page.elements.wardUnitCre.find(":selected").text();
            locationRegion.address = page.elements.addressUnitCre.val();

            unit.id = "0";
            unit.name = page.elements.nameUnitCre.val();
            unit.code = page.elements.codeUnitCre.val();
            unit.locationRegion = locationRegion;

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.saveUnit,
                "data": JSON.stringify(unit)
            })
                .done((item) => {
                    unit = item;
                    console.log(unit);

                    // let str = `
                    //     <option value="${unit.id}">${unit.name} (${unit.code})</option>
                    // `
                    //
                    // page.elements.unit.prepend(str);
                    page.commands.drawUnits();

                    page.elements.mdCreateUnit.modal('hide');
                    App.SweetAleart.showSuccessAlert(App.SUCCESS_CREATED);

                    page.commands.unbindAll();
                })
                .fail((jqxHR) => {
                    console.log(jqxHR)
                    page.dialogs.alertDanger.mdCreateUnit.html("").removeClass("hide").addClass("show");

                    if (jqxHR.status === 401) {
                        let msg = App.ERROR_401;
                        str = `<label id="message-error" class="error" for="message">${msg}</label>`

                        page.dialogs.alertDanger.mdCreateUnit.append(str);
                    } else {
                        if (jqxHR.status === 403) {
                            let msg = App.ERROR_403;
                            str = `<label id="message-error" class="error" for="message">${msg}</label>`

                            page.dialogs.alertDanger.mdCreateUnit.append(str);
                        } else {
                            let str = "";

                            if (jqxHR.responseJSON.message) {
                                let msg = jqxHR.responseJSON.message;

                                str = `<label id="message-error" class="error" for="message">${msg}</label>`

                                page.dialogs.alertDanger.mdCreateUnit.append(str);
                            }else if (jqxHR.responseJSON){
                                $.each(jqxHR.responseJSON, (key, item) => {
                                    str = `<label id="message-error" class="error" for="${key}">${item}</label>`
                                    page.dialogs.alertDanger.mdCreateUnit.append(str);
                                })
                            }
                        }
                    }
                })

        }

        page.commands.doRemoveCartItem = () => {
            App.SweetAleart.showSuspendedConfirmAlert()
                .then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            "type": "POST",
                            "headers": {
                                'accept': 'application/json',
                                'content-Type': 'application/json'
                            },
                            "url": page.url.delete + cartItemId

                        }).done((data) => {
                            cart = data;

                            $("#tr_" + cartItem.id).remove();
                            page.elements.quantityTotal.text(cart.quantityTotal);
                            page.elements.grandTotal.text(cart.grandTotal);

                            App.IziToast.showSuccessAlert("Delete cart item successful");

                        }).fail( () => {
                            App.IziToast.showErrorAlert("Delete cart item failed");
                        });
                    }
                })
        }

        page.commands.doOrder = () => {
            cart.unit = unit;
            cart.user.id = userDTOId;

            if (cart.id === undefined) {
                App.IziToast.showErrorAlertBottom("Cart is empty")
            }

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.saveOrder,
                "data": JSON.stringify(cart)
            })
                .done((item) => {
                    App.SweetAleart.showSuccessAlert("Successful");

                    window.location.href = page.url.redirectToOrderList;
                })
                .fail((jqxHR) => {
                    if (jqxHR.status === 401) {
                        App.IziToast.showErrorAlertBottom(App.ERROR_401)
                    } else {
                        if (jqxHR.status === 403) {
                            App.IziToast.showErrorAlertBottom(App.ERROR_403)
                        } else {
                            if (jqxHR.responseJSON.message) {
                                App.IziToast.showErrorAlertBottom(jqxHR.responseJSON.message)
                            }else if (jqxHR.responseJSON){
                                $.each(jqxHR.responseJSON, (key, item) => {
                                    App.IziToast.showErrorAlertBottom(item)
                                })
                            }
                        }
                    }
                })
        }

        page.commands.unbindAll = () => {
            $('.delete').off();
        }

        page.initializeControlEvent = () => {
            page.elements.provinceUnitCre.on('change', function () {
                locationRegion.provinceId = page.elements.provinceUnitCre.val();

                page.dialogs.commands.provinceChange().done(function () {
                    locationRegion.districtId = page.elements.districtUnitCre.prop("selectedIndex", 0).val();
                    page.dialogs.commands.districtChange();
                })
            })

            page.elements.districtUnitCre.on('change', function () {
                locationRegion.districtId = page.elements.districtUnitCre.val();
                page.dialogs.commands.districtChange();
            })

            // page.elements.btnCreateUnit.on('click', () => {
            //     page.commands.doCreateSupplier();
            // })
            //
            // page.elements.btnOrder.on('click', () => {
            //     page.commands.doOrder();
            // })

            page.elements.btnShowCreateSupplierModal.on('click', () => {
                page.elements.mdCreateSupplier.modal('show');
            })
        }

        $(function () {
            page.loadData.loadCartItems().then( function () {
                page.commands.clickRowCartItem();
            });

            page.commands.drawProvinces().then(function (){
                let provinceId = page.elements.provinceUnitCre.prop("selectedIndex", 0).val();

                if (provinceId != null) {
                    page.commands.drawDistricts(provinceId).then(function (){
                        let districtId = page.elements.districtUnitCre.prop("selectedIndex", 0).val();

                        if (districtId != null){
                            page.commands.drawWards(districtId);
                        }
                    })
                }
            });

            page.commands.drawUnits().then(function (){
                // unitId = 1;

                page.commands.unitChange();
            });

            page.initializeControlEvent();
        })


    </script>

</html>